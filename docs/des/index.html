<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Discrete Event Simulation</title>
<link href="../static/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="../static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../static/page.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<nav>
<a href="../">Home</a>
      ·
      <span class="dropdown">
<a href="#">Lessons</a>
<span class="dropdown-content" id="nav-lessons">
<a href="../intro/">Introduction</a>
<a href="../des/">Discrete Event Simulation</a>
<a href="../metrics/">Simple Metrics</a>
<a href="../scenarios/">Exploring Scenarios</a>
<a href="../interrupts/">Handling Interrupts</a>
<a href="../insight/">Insights</a>
<a href="../finale/">Conclusion</a>
</span>
</span>
      ·
      <span class="dropdown">
<a href="#">Appendices</a>
<span class="dropdown-content" id="nav-appendices">
<a href="../license/">License</a>
<a href="../conduct/">Code of Conduct</a>
<a href="../contributing/">Contributing</a>
<a href="../bibliography/">Bibliography</a>
<a href="../glossary/">Glossary</a>
</span>
</span>
</nav>
<main>
<h1>Discrete Event Simulation</h1>
<p id="terms">Terms defined: <a class="term-defined" href="dataclass">dataclass</a>, <a class="term-defined" href="random-exponential">exponential random distribution</a>, <a class="term-defined" href="generator">generator</a>, <a class="term-defined" href="random-log-normal">log-normal random distribution</a>, <a class="term-defined" href="median">median</a>, <a class="term-defined" href="parameter-sweeping">parameter sweeping</a>, <a class="term-defined" href="serialize">serialize</a></p>
<h2>Our First Simulation</h2>
<ul>
<li>Create a SimPy <code>Environment</code></li>
<li>Create one or more <a href="../glossary/#generator">generators</a> for it to run<ul>
<li>These will almost always need the environment</li>
</ul>
</li>
<li>Pass each generator to <code>env.process(…)</code></li>
<li>Call <code>env.run(…)</code> and specify simulation duration</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">simpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span>

<span class="n">T_SIM</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">T_WAIT</span> <span class="o">=</span> <span class="mi">8</span>


<span class="k">def</span><span class="w"> </span><span class="nf">coder</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">: Is there any work?"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">T_WAIT</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
    <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">coder</span><span class="p">(</span><span class="n">env</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">T_SIM</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Output</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">Is</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">work</span><span class="o">?</span>
<span class="mi">8</span><span class="o">:</span><span class="w"> </span><span class="n">Is</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">work</span><span class="o">?</span>
<span class="mi">16</span><span class="o">:</span><span class="w"> </span><span class="n">Is</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">work</span><span class="o">?</span>
<span class="mi">24</span><span class="o">:</span><span class="w"> </span><span class="n">Is</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">work</span><span class="o">?</span>
</code></pre></div>
<h2>Interaction</h2>
<ul>
<li>Manager creates jobs and puts them in a queue<ul>
<li>Jobs arrive at regular intervals</li>
<li>Each job has a duration</li>
<li>Give each job an ID for tracking</li>
</ul>
</li>
<li>Coder takes jobs from the queue in order and does them</li>
<li>Queue is implemented as a SimPy <code>Store</code> with <code>.put()</code> and <code>.get()</code> methods</li>
</ul>
<div class="callout">
<ul>
<li>A process (generator) only gives control back to SimPy when it yields</li>
<li>So processes must <code>yield</code> the results of <code>queue.put()</code> and <code>queue.get()</code><ul>
<li>Writing <code>job = queue.get()</code> rather than <code>job = yield queue.get()</code> is a common mistake</li>
</ul>
</li>
</ul>
</div>
<ul>
<li>Parameters</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="n">T_CREATE</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">T_JOB</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">T_SIM</span> <span class="o">=</span> <span class="mi">20</span>
</code></pre></div>
<ul>
<li><code>Job</code> class</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Job</span><span class="p">:</span>
    <span class="n">_next_id</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">Job</span><span class="o">.</span><span class="n">_next_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">T_JOB</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"job-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
<ul>
<li><code>manager</code> process</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">manager</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"manager creates </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">T_CREATE</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>coder</code> process</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">coder</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"coder waits at </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"coder gets </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"code completes </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Set up and run</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">manager</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">coder</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span>
    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">T_SIM</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Output</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code>manager creates job-0 at 0
coder waits at 0
coder gets job-0 at 0
manager creates job-1 at 6
code completes job-0 at 8
coder waits at 8
coder gets job-1 at 8
manager creates job-2 at 12
code completes job-1 at 16
coder waits at 16
coder gets job-2 at 16
manager creates job-3 at 18
</code></pre></div>
<ul>
<li>Easier to see as columns</li>
</ul>
<div class="row">
<div class="col-5">
<div class="codehilite"><pre class=""><span></span><code>manager creates job-0 at 0
manager creates job-1 at 6
manager creates job-2 at 12
manager creates job-3 at 18
</code></pre></div>
</div>
<div class="col-1">
</div>
<div class="col-5">
<div class="codehilite"><pre class=""><span></span><code>coder waits at 0
coder gets job-0 at 0
coder waits at 8
coder gets job-1 at 8
coder waits at 16
coder gets job-2 at 16
</code></pre></div>
</div>
</div>
<ul>
<li>But even this is hard to read</li>
</ul>
<h2>Uniform Rates</h2>
<ul>
<li>Use ranges for creation times and job durations</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="n">RNG_SEED</span> <span class="o">=</span> <span class="mi">98765</span>
<span class="n">T_CREATE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">T_JOB</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">T_SIM</span> <span class="o">=</span> <span class="mi">20</span>
</code></pre></div>
<ul>
<li><code>Job</code> has a random duration</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Job</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">Job</span><span class="o">.</span><span class="n">_next_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">T_JOB</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>manager</code> waits a random time before creating the next job<ul>
<li>Format time to two decimal places for readability</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">manager</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"manager creates </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">T_CREATE</span><span class="p">))</span>
</code></pre></div>
<ul>
<li>Always initialize the random number generator to ensure reproducibility<ul>
<li>Hard to debug if the program behaves differently each time we run it</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RNG_SEED</span><span class="p">)</span>
    <span class="c1"># …as before…</span>
</code></pre></div>
<div class="row">
<div class="col-5">
<div class="codehilite"><pre class=""><span></span><code>manager creates job-0 at 0.00
manager creates job-1 at 8.36
manager creates job-2 at 14.73
</code></pre></div>
</div>
<div class="col-1">
</div>
<div class="col-5">
<div class="codehilite"><pre class=""><span></span><code>coder waits at 0.00
coder gets job-0 at 0.00
coder waits at 8.52
coder gets job-1 at 8.52
</code></pre></div>
</div>
</div>
<h2>Better Random Distributions</h2>
<ul>
<li>Assume probability of manager generating a new job in any instant is fixed<ul>
<li>I.e., doesn't depend on how long since the last job was generated</li>
</ul>
</li>
<li>If the arrival rate (jobs per tick) is λ,
    the time until the next job is an <a href="../glossary/#random-exponential">exponential</a> random variable
    with mean 1/λ</li>
</ul>
<div class="center">
<img alt="exponential distribution" src="exponential.svg"/>
</div>
<ul>
<li>Use a <a href="../glossary/#random-log-normal">log-normal</a> random variable to model job lengths<ul>
<li>All job lengths are positive</li>
<li>Most jobs are short but there are a few outliers</li>
<li>If parameters are μ and σ, the <a href="../glossary/#median">median</a> is e<sup>μ</sup></li>
</ul>
</li>
</ul>
<div class="center">
<img alt="log-normal distribution" src="lognormal.svg"/>
</div>
<h2>Better Random Interaction</h2>
<ul>
<li>Parameters and randomization functions</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="err">…</span><span class="n">other</span> <span class="n">parameters</span> <span class="k">as</span> <span class="n">before</span><span class="err">…</span>
<span class="n">T_JOB_INTERVAL</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">T_JOB_MEAN</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">T_JOB_STD</span> <span class="o">=</span> <span class="mf">0.6</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rand_job_arrival</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">expovariate</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">T_JOB_INTERVAL</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rand_job_duration</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">lognormvariate</span><span class="p">(</span><span class="n">T_JOB_MEAN</span><span class="p">,</span> <span class="n">T_JOB_STD</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Corresponding changes to <code>Job</code> and <code>manager</code></li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Job</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">Job</span><span class="o">.</span><span class="n">_next_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">rand_job_duration</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">manager</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">()</span>
        <span class="n">t_delay</span> <span class="o">=</span> <span class="n">rand_job_arrival</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"manager creates </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> waits for </span><span class="si">{</span><span class="n">t_delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">t_delay</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Results</li>
</ul>
<div class="row">
<div class="col-5">
<div class="codehilite"><pre class=""><span></span><code><span class="nv">manager</span><span class="w"> </span><span class="nv">creates</span><span class="w"> </span><span class="nv">job</span><span class="o">-</span><span class="mi">0</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="mi">0</span>.<span class="mi">00</span><span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">7</span>.<span class="mi">96</span>
<span class="nv">manager</span><span class="w"> </span><span class="nv">creates</span><span class="w"> </span><span class="nv">job</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="mi">7</span>.<span class="mi">96</span><span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">0</span>.<span class="mi">60</span>
<span class="nv">manager</span><span class="w"> </span><span class="nv">creates</span><span class="w"> </span><span class="nv">job</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="mi">8</span>.<span class="mi">56</span><span class="w"> </span><span class="nv">waits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">3</span>.<span class="mi">70</span>
</code></pre></div>
</div>
<div class="col-1">
</div>
<div class="col-5">
<div class="codehilite"><pre class=""><span></span><code>coder waits at 0.00
coder gets job-0 at 0.00
coder waits at 0.65
coder gets job-1 at 7.96
coder waits at 8.75
coder gets job-2 at 8.75
</code></pre></div>
</div>
</div>
<ul>
<li>But this is still hard to read and analyze</li>
</ul>
<h2>Introduce Structure</h2>
<ul>
<li>Requirements<ul>
<li>Save results as JSON to simplify analysis</li>
<li>Simulation may have several pieces, so put them in one object</li>
<li>Support <a href="../glossary/#parameter-sweeping">parameter sweeping</a></li>
</ul>
</li>
<li>Store parameters in a <a href="../glossary/#dataclass">dataclass</a><ul>
<li>Each parameter must have a default value so utilities can construct instances
    without knowing anything about specific parameters</li>
<li>Use <code>@dataclass_json</code> decorator so that utilities can <a href="../glossary/#serialize">serialize</a> as JSON</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="nd">@dataclass_json</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Params</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Simulation parameters."""</span>

    <span class="n">n_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">13579</span>
    <span class="n">t_sim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">t_wait</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span>
</code></pre></div>
<ul>
<li>Define another class to store the entire simulation<ul>
<li>Derive from SimPy <code>Environment</code></li>
<li>Store simulation parameters as <code>.params</code></li>
<li>May have other structures (e.g., a log to record output)</li>
<li>Give it a <code>.result()</code> method that returns simulation result (e.g., the log)</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">(</span><span class="n">Environment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Complete simulation."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"log"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">}</span>
</code></pre></div>
<ul>
<li>All of the simulation process generator functions take an instance of the simulation class as an argument<ul>
<li><code>sim.whatever</code> for elements of the SimPy <code>Environment</code></li>
<li><code>sim.params.whatever</code> for parameters</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">coder</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Simulate a single coder."""</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">: Is there any work?"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">t_wait</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Define a <code>Simulation.simulate</code> method that creates processes and runs the simulation<ul>
<li>Can't call it <code>run</code> because we need that method from the parent class <code>Environment</code></li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">coder</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">t_sim</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Use <code>util.run(…)</code> to run scenarios with varying parameters and get result as JSON<ul>
<li>Look in project's <code>utilities</code> directory for implementation</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Params</span><span class="p">,</span> <span class="n">Simulation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">as_frames</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"## </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Sample command line invocation</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code>python<span class="w"> </span>introduce_structure.py<span class="w"> </span>--json<span class="w"> </span><span class="nv">t_wait</span><span class="o">=</span><span class="m">12</span>,20<span class="w"> </span><span class="nv">t_sim</span><span class="o">=</span><span class="m">20</span>,30
</code></pre></div>
<ul>
<li>Output</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"n_seed"</span><span class="p">:</span><span class="w"> </span><span class="mi">13579</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_sim"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_wait"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">},</span>
<span class="w">      </span><span class="nt">"log"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 0"</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 1"</span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"n_seed"</span><span class="p">:</span><span class="w"> </span><span class="mi">13579</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_sim"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_wait"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">},</span>
<span class="w">      </span><span class="nt">"log"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 0"</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 1"</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 2"</span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"n_seed"</span><span class="p">:</span><span class="w"> </span><span class="mi">13579</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_sim"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_wait"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">},</span>
<span class="w">      </span><span class="nt">"log"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 0"</span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"n_seed"</span><span class="p">:</span><span class="w"> </span><span class="mi">13579</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_sim"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nt">"t_wait"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">},</span>
<span class="w">      </span><span class="nt">"log"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 0"</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"time"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loop 1"</span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Convert to <a href="https://pola.rs/">Polars</a> dataframes)<ul>
<li>Include all parameters in each dataframe to simplify later analysis</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code>python<span class="w"> </span>introduce_structure.py<span class="w"> </span>--tables<span class="w"> </span><span class="nv">t_wait</span><span class="o">=</span><span class="m">12</span>,20<span class="w"> </span><span class="nv">t_sim</span><span class="o">=</span><span class="m">20</span>,30
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code><span class="gu">##</span> log
shape: (8, 5)
<span class="gu">##</span> log
shape: (8, 6)
┌──────┬─────────┬─────┬────────┬───────┬────────┐
│ time ┆ message ┆ id  ┆ n_seed ┆ t_sim ┆ t_wait │
│ ---  ┆ ---     ┆ --- ┆ ---    ┆ ---   ┆ ---    │
│ i64  ┆ str     ┆ i32 ┆ i32    ┆ i32   ┆ i32    │
╞══════╪═════════╪═════╪════════╪═══════╪════════╡
│ 0    ┆ loop 0  ┆ 0   ┆ 13579  ┆ 20    ┆ 12     │
│ 12   ┆ loop 1  ┆ 0   ┆ 13579  ┆ 20    ┆ 12     │
│ 0    ┆ loop 0  ┆ 1   ┆ 13579  ┆ 30    ┆ 12     │
│ 12   ┆ loop 1  ┆ 1   ┆ 13579  ┆ 30    ┆ 12     │
│ 24   ┆ loop 2  ┆ 1   ┆ 13579  ┆ 30    ┆ 12     │
│ 0    ┆ loop 0  ┆ 2   ┆ 13579  ┆ 20    ┆ 20     │
│ 0    ┆ loop 0  ┆ 3   ┆ 13579  ┆ 30    ┆ 20     │
│ 20   ┆ loop 1  ┆ 3   ┆ 13579  ┆ 30    ┆ 20     │
└──────┴─────────┴─────┴────────┴───────┴────────┘
</code></pre></div>
</main>
<footer>
<div class="row">
<div class="col-3 left">
	  ⇐ <a href="../intro/">Introduction</a>
</div>
<div class="col-6 center">
<a href="../"></a>
	  © 2026
	  <a href="../#acknowledgments">the authors</a>
</div>
<div class="col-3 right">
<a href="../metrics/">Simple Metrics</a> ⇒
	</div>
</div>
</footer>
</body>
</html>